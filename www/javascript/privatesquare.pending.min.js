function privatesquare_pending_init(){var b=privatesquare_deferred_list();if(b.length==0)privatesquare_set_status("There are no pending checkins to administriviate.");else{var a="<optgroup>",c=function(f){var h=Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");f.getFullYear();var i=f.getDate();return h[f.getMonth()]+" "+i};for(var d in b){var e=b[d],g=new Date(e.created*1E3);a+='<option value="'+htmlspecialchars(e.id)+'">';a+=c(g)+' at "';a+=htmlspecialchars(e.venue);
a+='"</option>'}a+="</optgroup>";a+='<optgroup class="admin">';a+='<option value="__purge__">';a+=b.length>1?"Delete all pending checkins":"Just forget this checkin";a+="</option>";a+="</optgroup>";$("#checkins").html(a);a=$("#deferred");a.attr("data-count-pending",b.length);a.submit(privatesquare_pending_onselect);a.show()}}
function privatesquare_pending_onselect(){var b=$("#deferred"),a=$("#checkins"),c=a.val();if(c=="__purge__"){c="Are you sure you want to delete all those pending checkins?";if(b.attr("data-count-pending")==1)c="Are you sure you want to delete this checkin?";if(confirm(c)){a.html("");b.hide();privatesquare_deferred_purge();privatesquare_set_status("Okay all your pending checkins have been deleted.")}}else{a=privatesquare_deferred_get_by_id(c);privatesquare_pending_fetch_venues(a);b.hide()}return false}
function privatesquare_pending_fetch_venues(b){$.ajax({url:_cfg.abs_root_url+"api/",data:{method:"foursquare.venues.search",latitude:b.latitude,longitude:b.longitude,query:b.venue},success:function(a){a.checkin=b;_foo(a)}});privatesquare_set_status("Fetching nearby places...")}
function _foo(b){privatesquare_unset_status();if(b.stat!="ok")privatesquare_set_status("FAIL:api");else{var a=b.venues.length;if(a){for(var c="",d=0;d<a;d++){var e=b.venues[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}c+='<option value="-1">\u2013\u2013 none of the above / search \u2013\u2013</option>';a=$("#where");a.attr("data-crumb",b.crumb);a.attr("data-checkin-id",b.checkin.id);a.html(c);a.change(_privatesquare_where_onchange);$("#what").change(_privatesquare_what_onchange);_privatesquare_show_map(b.latitude,
b.longitude);privatesquare_unset_status();$("#venues").show();$("#checkin").submit(function(){try{_privatesquare_pending_onsubmit()}catch(g){console.log(g)}return false})}else privatesquare_set_status("FAIL: no venues")}}
function _privatesquare_pending_onsubmit(){var b=privatesquare_gather_args();if(b.venue_id==-1){privatesquare_search();return false}var a=$("#where").attr("data-checkin-id"),c=privatesquare_deferred_get_by_id(a);b.created=c.created;privatesquare_checkin(b,function(d){d.checkin=c;_privatesquare_pending_checkin_onsuccess(d)});$("#venues").hide();_privatesquare_hide_map();privatesquare_set_status("Checking in...");return false}
function _privatesquare_pending_checkin_onsuccess(b){console.log(b);privatesquare_deferred_remove(b.checkin.id)};
