var checking_in=false,searching=false;function privatesquare_init(){navigator.geolocation.getCurrentPosition(_privatesquare_geolocation_onsuccess,_privatesquare_geolocation_onerror);$("#checkin").submit(privatesquare_submit);$("#again").click(privatesquare_reset);privatesquare_set_status("Asking the sky where you are...")}
function _privatesquare_geolocation_onsuccess(a){var b=a.coords.latitude;a=a.coords.longitude;!window.navigator.onLine&&_cfg.deferred_checkins?privatesquare_deferred_checkin(b,a,"offline"):privatesquare_fetch_venues(b,a)}function _privatesquare_geolocation_onerror(){privatesquare_set_status("Huh. I have no idea where you are...")}function privatesquare_reset(){$("#venues").hide();privatesquare_unset_status();_privatesquare_hide_map();privatesquare_init()}
function privatesquare_submit(){var a=privatesquare_gather_args();if(a.venue_id==-1){privatesquare_search();return false}privatesquare_checkin(a,privatesquare_checkin_onsuccess);$("#venues").hide();_privatesquare_hide_map();privatesquare_set_status("Checking in...");return false}
function privatesquare_gather_args(){var a=$("#where").val(),b=$("#what").val(),c=$("#broadcast").val();c=b==2?"":c;var e=$("#where").attr("data-crumb"),d=$("#where").attr("data-created");a={crumb:e,venue_id:a,status_id:b,broadcast:c};if(d)a.created=d;return a}
function privatesquare_checkin(a,b){if(checking_in)return false;b||(b=privatesquare_checkin_onsuccess);checking_in=true;a.method="privatesquare.venues.checkin";$.ajax({url:_cfg.abs_root_url+"api/",type:"POST",data:a,error:function(){checking_in=false},success:function(c){checking_in=false;b(c)}})}
function privatesquare_search(){if(searching)return false;searching=true;_privatesquare_hide_map();$("#venues").hide();var a=prompt("Search for a particular place");if(!a){privatesquare_set_status('Okay, I\'m giving up. <a href="#" onclick="privatesquare_init();return false;">Start over</a> if you want change your mind.');return false}navigator.geolocation.getCurrentPosition(function(b){privatesquare_fetch_venues(b.coords.latitude,b.coords.longitude,a);searching=false},function(){});privatesquare_set_status("Re-checking your location first...");
return false}function privatesquare_fetch_venues(a,b,c,e){a={method:"foursquare.venues.search",latitude:a,longitude:b};if(c!="")a.query=c;$.ajax({url:_cfg.abs_root_url+"api/",data:a,success:function(d){_foursquare_venues_onsuccess(d,e)}});privatesquare_set_status("Fetching nearby places...")}
function _foursquare_venues_onsuccess(a,b){$("#status").html("");if(a.stat!="ok"&&!b)navigator.geolocation.getCurrentPosition(function(g){privatesquare_deferred_checkin(g.coords.latitude,g.coords.longitude,"api error")},function(){privatesquare_api_error(a)});else{var c=a.venues.length;if(c){for(var e="",d=0;d<c;d++){var f=a.venues[d];e+='<option value="'+f.id+'">'+f.name+"</option>"}e+='<option value="-1">\u2013\u2013 none of the above / search \u2013\u2013</option>';c=$("#where");c.attr("data-crumb",
a.crumb);b&&c.attr("data-created",b);c.html(e);c.change(_privatesquare_where_onchange);$("#what").change(_privatesquare_what_onchange);_privatesquare_show_map(a.latitude,a.longitude);privatesquare_unset_status();$("#venues").show();$("#checkin").submit(privatesquare_submit)}else{e="You appear to have fallen in to a black hole. There's nothing around here";if(a.query)e+=" that looks like <q>"+htmlspecialchars(a.query)+"</q>";e+='. <a href="#" onclick="privatesquare_search();return false;">Try again</a>';
e+=' or <a href="#" onclick="privatesquare_init();return false;">start from scratch</a>?';privatesquare_set_status(e)}}}function _privatesquare_where_onchange(){$("#where").val()==-1&&privatesquare_search();return false}function _privatesquare_what_onchange(){var a=$("#what").val(),b=$("#broadcast");a==2?b.attr("disabled","disabled"):b.removeAttr("disabled")}
function privatesquare_checkin_onsuccess(a,b){$("#status").html("");b||(b=privatesquare_init);if(a.stat!="ok")privatesquare_api_error(a,b);else location.href=_cfg.abs_root_url+"venue/"+a.checkin.venue_id+"?success=1"}
function privatesquare_api_error(a,b){var c="Oh noes. There was a problem completing your request. ",e=a.error;if(e){c+="The robot monkeys report: ";c+=e.error+" (error code #"+e.code+"). "}else c+="It appears to be a privatesquare problem rather than foursquare weirdness. ";if(b){c+='<button id="tryagain">Try it again?</button>';c+="&#160;&#160;";c+='<button id="donot_tryagain">Forget it</button>'}privatesquare_set_status(c);if(b){$("#tryagain").click(b);$("#donot_tryagain").click(function(){$("#status").html("");
$("#status").hide()})}}function _privatesquare_show_map(a,b){var c=a+","+b,e=$("#map-wrapper"),d=document.createElement("div");d=$(d);d.attr("class","map");d.attr("data-zoom",14);d.attr("data-center",c);d.attr("data-hash",false);d.attr("data-touch",true);d.attr("data-provider","toner");var f=document.createElement("div");f=$(f);f.attr("class","marker");f.attr("data-location",c);f.html("you are here-ish");d.html(f);e.html(d);e.show();privatesquare_htmapl(d)}
function privatesquare_htmapl(a){a||(a=$(".map"));try{a.htmapl()}catch(b){a.html('<div class="map-error">hrmph...failed to load map: '+b+"</div>")}}function _privatesquare_hide_map(){var a=$("#map-wrapper"),b=$(".map");a.hide();b.remove()}function privatesquare_set_status(a){$("#status").html(a);$("#status").show()}function privatesquare_unset_status(){$("#status").html("");$("#status").hide()};
